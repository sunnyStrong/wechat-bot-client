# 需求

1. 使用指令管理系统模块
2. 使用数据库连接系统模块
3. AI 根据使用量计费。

# 数据库连接设计

在使用机器人时主要需要有很大部分的持久化需求

- 系统配置
- 模块配置
  - 模块基本配置
  - 模块目标配置
    - 群组配置
    - 人配置
- 运行状态
  - 系统某些状态
  - 某些模块状态
- 用户管理
- 权限管理
  - 用户授权
  - 群组授权
  - 群组中用户授权

以 ChatGPT 模块为例子，需要存储的内容有：

1. 人员调用记录
2. 消费 token 记录
3. 用户/群组模型配置
4. 用户/群组 sys_prompt 配置
5. 用户/群组上下文信息

# 数据库设计

## 1. 用户表

- [x] 用户表
  - 真实用户/租户
- [x] 群组表
- [x] 用户群组表

## 2. 系统表

- [x] 系统配置表
- [x] 系统模块表

## 3. 模块表

- [x] 模块配置表
- [ ] 模块权限表
  - 用户权限
  - 群组权限
  - 用户群组权限
  - 白/黑名单字段

## 4. 具体模块业务表

以 `mod_module_code` 开头

# 数据库连接管理

系统管理系统模块的表，各模块表由各个模块管理

# 模块权限设计

- [ ] TODO

模块权限使用黑白名单制度设计，数据库表中应该有一个字段：black_list。模块权限默认为白名单模式。用户和群组均为白名单。

# 模块权限过滤链实现

- [ ] TODO

# 系统指令设计

使用 sysCall 来调用系统函数，并返回响应。

# 系统模块设计

- [ ] TODO
在以前各模块是通过广播发送消息的，现在要变更逻辑，模块需要注册到 server 中。

## 模块注册流程

- [ ] TODO

在模块启动时应有一条模块注册消息，里面需要携带模块 ID，以及一个 js 脚本用于确定消息是否该由模块处理，以及模块需要有心跳。

远程的模块需要通过系统调用的方式进行模块配置。

## 模块处理流程

- [ ] TODO

各模块之间通过链式串联，称为 ModuleProcessChain，在每个群、每个用户上面拥有不同的优先级。优先级为数字，可通过优先级排序，最低优先级的为默认模块，若为默认模块则没有启动指令。