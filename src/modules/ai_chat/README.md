# 大语言模型对话模块

## 概述

该模块主要用于接收用户消息，并传递给大语言模型。由大语言模型回复后返回给用户。

## 基础用法

- 单聊 `ai 要给ai发送的消息`
- 群聊 `@机器人用户 ai 要给ai发送的消息`
- 命令
  - `ai /命令名称 命令值`
  - `@机器人用户 ai /命令名称 命令值`

## 配置

配置使用 `sys_module_config` 表，不带前缀的为基础配置

### 模块基础配置

| 配置键          | 必填 | 配置值                     | 默认值                  | 值类型 | 备注                                                         |
| --------------- | ---- | -------------------------- | ------ | ------------------------------------------------------------ | --------------- |
| memory           |   | 最多保留几条上下文信息 | 6 | string | 大部分大语言模型长度都是和上下文有关的，需要留意长度 |
| singleContactWhiteList | ✅ | ["用户ID1", "用户ID2"] | [] | json | 只有在白名单中的用户才能使用该模块。后续等权限系统开发后废弃 |
| attachedRoomId | ✅ | ["群ID1", "群ID2"] | [] | json | 只有在白名单中的群才能使用该模块。后续等权限系统开发后废弃 |
| datasource | ✅ | 数据源配置 |  | json | 用于配置连接的数据源，需要拥有一张 token 计费表 |
| moduleType |  | 大模型类型，[<br />baiduThousandSails=百度千帆<br />chatGpt=chatgpt<br />] | chatGpt | string | 配置大模型的类型，可以为不同群不同用户指定不同大模型 |

### 模块大模型配置

用户 ID 的配置项含义为： 为该用户指定配置

群组 ID 的配置项含义为： 为该群指定配置

若两者都有则为该群中的用户配置

| 配置键                   | 必填 | 配置值                                                       | 默认值 | 值类型 | 备注                                    |
| ------------------------ | ---- | ------------------------------------------------------------ | ------ | ------ | --------------------------------------- |
| 【模型名称】.modulePrice | ✅    | 模块价格，需要配置每个模型的输入输出价格，如{"gpt-3.5-turbo-0301_output":0.002,"gpt-3.5-turbo-0301_input":0.0015"......} |        | json   | 大模型 token 价格，用于计算大模型消耗量 |
| 【模型名称】.prompt      |      | 指向该群/用户的 prompt 配置，可以为模块设定人设              |        | string |                                         |
| 【模型名称】.baseUrl     | ✅    | 大模型的访问地址                                             |        | string | 必须配置该项                            |

### chatgpt 配置

| 配置键          | 必填 | 配置值                     | 默认值                  | 值类型 | 备注                                                         |
| --------------- | ---- | -------------------------- | ------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| chatGpt.module | ✅   | 模型名称，如 gpt-3.5-turbo， gpt-4 |  | string | 模型类型，不同模型价格不同。 |
| chatGpt.proxy |      | 网络环境通过代理访问 chatGpt.。`{"protocol":"http","host":"127.0.0.1","port":7890}` |     | json | 若网络环境好，无需配置 |
| chatGpt.auth | ✅    | chatgpt 认证。填入 gpt 的 token。<br />`{"type":"bearer", "token":"sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxx"}"}` |                        | json | 认证                        |

### baiduThousandSails 配置

[百度千帆](https://cloud.baidu.com/product/wenxinworkshop)

| 配置键                          | 必填 | 配置值                         | 默认值 | 值类型 | 备注 |
| ------------------------------- | ---- | ------------------------------ | ------ | ------ | ---- |
| baiduThousandSails.apiKey       | ✅    | apiKey，从百度那里申请的       |        | string |      |
| baiduThousandSails.clientSecret | ✅    | clientSecret，从百度那里申请的 |        | string |      |

## 指令

| 命令          | 范围  | 作用                         | 值   | 备注                                       |
| ------------- | ----- | ---------------------------- | ---- | ------------------------------------------ |
| /config       | 👨     | 为用户配置 prompt            |      | 配置后会清除缓存上下文保证 prompt 生效状态 |
| /config_group | 👨‍👩‍👧‍👦  | 为群配置 prompt              |      | 配置后会清除缓存上下文保证 prompt 生效状态 |
| /clear        | 👨👨‍👩‍👧‍👦 | 清除除了 prompt 以外的上下文 |      |                                            |
| /clear_all    | 👨👨‍👩‍👧‍👦 | 清除包括 prompt 的上下文     |      |                                            |

## 流程

1. 获取模块所有配置
2. 消息预处理
3. 判断配置中使用的 `moduleType`
4. 判断是否为指令
   1. 执行指令
   2. 结束
5. 请求大语言模型
6. 记录该次请求消耗的 `token`
7. 返回给用户